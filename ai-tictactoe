<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tic-Tac-Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss">
        /* Custom styles */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }
        .cell {
            @apply w-20 h-20 md:w-28 md:h-28 bg-gray-800 border-4 border-gray-700 rounded-lg flex items-center justify-center text-5xl md:text-6xl font-bold cursor-pointer transition-all duration-300;
            @apply disabled:cursor-not-allowed disabled:opacity-70;
            @apply hover:bg-gray-700;
            font-family: inherit;
        }
        .cell.player { @apply text-blue-400; }
        .cell.opponent { @apply text-red-400; } /* Used for AI or Player 2 */
        .cell.win { @apply bg-yellow-500 text-gray-900; }
        
        .btn { @apply px-4 py-2 rounded-lg font-semibold text-white transition-all duration-200 shadow-md; }
        .btn-difficulty { @apply btn bg-gray-600 hover:bg-gray-500 text-xs md:text-sm; }
        .btn-difficulty.active { @apply bg-blue-600 ring-2 ring-blue-300; }
        
        .btn-primary { @apply btn bg-green-600 hover:bg-green-500 text-lg w-full; }
        
        .input-field { @apply w-full px-4 py-3 bg-gray-700 rounded-lg border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500; }
        
        /* Marker Radio Styles */
        .marker-selection label {
            @apply block w-16 h-16 flex items-center justify-center text-4xl bg-gray-700 rounded-lg cursor-pointer border-2 border-transparent transition-all hover:bg-gray-600;
        }
        .marker-selection input[type="radio"]:checked + label {
            @apply bg-blue-600 border-blue-300 ring-2 ring-blue-300;
        }

        /* Mode Selection Styles */
        .mode-selection label {
            @apply block px-4 py-3 bg-gray-700 rounded-lg cursor-pointer border-2 border-transparent text-center font-bold text-gray-300 hover:bg-gray-600 transition-all;
        }
        .mode-selection input[type="radio"]:checked + label {
            @apply bg-purple-600 border-purple-300 text-white shadow-lg;
        }

        /* Chat Panel */
        #chat-container { @apply w-full max-w-md bg-gray-800 shadow-2xl rounded-2xl p-4 md:p-6 flex flex-col h-[500px]; }
        #chat-messages { @apply flex-grow overflow-y-auto mb-4 p-3 bg-gray-900 rounded-lg space-y-3; }
        .chat-message { @apply p-3 rounded-lg max-w-[90%] text-sm; }
        .chat-message.ai { @apply bg-gray-700 mr-auto text-white; }
        .chat-message.system { @apply bg-blue-900/50 mx-auto text-center text-blue-200 text-xs italic w-full; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <div id="setup-container" class="w-full max-w-md mx-auto bg-gray-800 shadow-2xl rounded-2xl p-6 md:p-8">
        <h1 class="text-4xl font-bold text-center mb-6 text-blue-400">AI Trainer</h1>
        
        <div class="space-y-4 mb-6">
            <div>
                <label class="block text-sm font-medium mb-1">Your Name</label>
                <input type="text" id="player-name" class="input-field" placeholder="Player 1">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Gemini API Key (Optional)</label>
                <input type="password" id="api-key" class="input-field" placeholder="For AI reactions...">
                <div class="text-xs text-gray-500 mt-1 text-right"><a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-400 hover:underline">Get Key</a></div>
            </div>
        </div>

        <div class="mb-6">
            <label class="block text-sm font-medium mb-2 text-center">Game Mode</label>
            <div class="grid grid-cols-2 gap-4 mode-selection">
                <div>
                    <input type="radio" id="mode-bot" name="gamemode" value="bot" class="hidden" checked>
                    <label for="mode-bot">VS AI Bot</label>
                </div>
                <div>
                    <input type="radio" id="mode-offline" name="gamemode" value="offline" class="hidden">
                    <label for="mode-offline">2 Player (Offline)</label>
                </div>
            </div>
        </div>

        <div class="mb-8">
            <label class="block text-sm font-medium mb-2 text-center">Choose Marker</label>
            <div class="flex justify-center space-x-4 marker-selection">
                <input type="radio" id="marker-x" name="marker" value="X" class="hidden" checked>
                <label for="marker-x">X</label>

                <input type="radio" id="marker-o" name="marker" value="O" class="hidden">
                <label for="marker-o">O</label>

                <input type="radio" id="marker-ghost" name="marker" value="ðŸ‘»" class="hidden">
                <label for="marker-ghost">ðŸ‘»</label>
            </div>
        </div>

        <button id="start-game-btn" class="btn-primary">Start Game</button>
    </div>

    <div id="app-container" class="w-full max-w-5xl mx-auto hidden">
        <div class="flex flex-col md:flex-row gap-6 justify-center">
            
            <main class="w-full max-w-md mx-auto bg-gray-800 shadow-2xl rounded-2xl p-6 relative">
                
                <div class="flex justify-between items-center bg-gray-900 rounded-lg p-3 mb-4 border border-gray-700">
                    <div class="text-center w-1/3">
                        <div class="text-xs text-gray-400 uppercase">You</div>
                        <div id="score-p1" class="text-2xl font-bold text-blue-400">0</div>
                    </div>
                    <div class="text-center w-1/3 text-gray-600 font-bold">VS</div>
                    <div class="text-center w-1/3">
                        <div id="opponent-label" class="text-xs text-gray-400 uppercase">AI</div>
                        <div id="score-p2" class="text-2xl font-bold text-red-400">0</div>
                    </div>
                </div>

                <div id="difficulty-panel" class="flex justify-center space-x-2 mb-4">
                    <button data-level="Easy" class="btn-difficulty">Easy</button>
                    <button data-level="Medium" class="btn-difficulty">Medium</button>
                    <button data-level="Hard" class="btn-difficulty">Hard</button>
                    <button data-level="Adaptive" class="btn-difficulty active">Adaptive</button>
                </div>

                <div class="text-center mb-4">
                    <p id="status" class="text-xl font-semibold h-8 text-blue-300">Your Turn</p>
                </div>

                <div id="board" class="grid grid-cols-3 gap-3 mb-6">
                    <button class="cell" data-i="0"></button>
                    <button class="cell" data-i="1"></button>
                    <button class="cell" data-i="2"></button>
                    <button class="cell" data-i="3"></button>
                    <button class="cell" data-i="4"></button>
                    <button class="cell" data-i="5"></button>
                    <button class="cell" data-i="6"></button>
                    <button class="cell" data-i="7"></button>
                    <button class="cell" data-i="8"></button>
                </div>

                <button id="restart-btn" class="btn-primary">New Game</button>
            </main>

            <aside id="chat-container">
                <div class="border-b border-gray-700 pb-2 mb-2">
                    <h2 class="text-xl font-bold text-gray-300 flex items-center gap-2">
                        <span>ðŸ’¬</span> Game Commentary
                    </h2>
                    <p class="text-xs text-gray-500">AI reacts to game results</p>
                </div>
                <div id="chat-messages">
                    </div>
                </aside>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE ---
            let gameState = {
                board: Array(9).fill(''),
                isActive: false,
                mode: 'bot', // 'bot' or 'offline'
                p1Name: 'Player',
                p1Marker: 'X',
                p2Marker: 'O', // AI or Player 2
                currentPlayer: 'X',
                difficulty: 'Adaptive',
                adaptiveLevel: 1, // 0:Easy, 1:Med, 2:Hard
                scores: { p1: 0, p2: 0 },
                apiKey: ''
            };

            const winPatterns = [
                [0,1,2], [3,4,5], [6,7,8], 
                [0,3,6], [1,4,7], [2,5,8], 
                [0,4,8], [2,4,6]
            ];

            // --- DOM ---
            const cells = document.querySelectorAll('.cell');
            const statusDisplay = document.getElementById('status');
            const chatBox = document.getElementById('chat-messages');
            const diffBtns = document.querySelectorAll('.btn-difficulty');
            const scoreP1 = document.getElementById('score-p1');
            const scoreP2 = document.getElementById('score-p2');

            // --- SETUP HANDLERS ---
            document.getElementById('start-game-btn').addEventListener('click', () => {
                gameState.p1Name = document.getElementById('player-name').value || 'Player';
                gameState.apiKey = document.getElementById('api-key').value.trim();
                gameState.mode = document.querySelector('input[name="gamemode"]:checked').value;
                gameState.p1Marker = document.querySelector('input[name="marker"]:checked').value;

                // Configure Markers
                const map = { 'X': 'O', 'O': 'X', 'ðŸ‘»': 'ðŸŽƒ' };
                gameState.p2Marker = map[gameState.p1Marker];

                // UI Setup
                document.getElementById('setup-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                
                // Adjust UI based on mode
                if (gameState.mode === 'offline') {
                    document.getElementById('difficulty-panel').classList.add('hidden');
                    document.getElementById('opponent-label').innerText = "Player 2";
                    addSystemMsg("Game Mode: 2 Player Offline (Hotseat)");
                } else {
                    document.getElementById('opponent-label').innerText = "AI Bot";
                    addSystemMsg(`Game Mode: VS AI (${gameState.difficulty})`);
                    if(gameState.apiKey) addSystemMsg("AI Commentary: Enabled ðŸŸ¢");
                    else addSystemMsg("AI Commentary: Disabled (No Key) âšª");
                }

                initGame();
            });

            document.getElementById('restart-btn').addEventListener('click', initGame);

            diffBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    diffBtns.forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    gameState.difficulty = e.target.dataset.level;
                    
                    if (gameState.difficulty === 'Easy') gameState.adaptiveLevel = 0;
                    if (gameState.difficulty === 'Medium') gameState.adaptiveLevel = 1;
                    if (gameState.difficulty === 'Hard') gameState.adaptiveLevel = 2;
                    
                    initGame();
                });
            });

            cells.forEach(cell => {
                cell.addEventListener('click', (e) => {
                    const i = e.target.dataset.i;
                    if (gameState.board[i] !== '' || !gameState.isActive) return;
                    
                    // Human Move
                    if (gameState.mode === 'bot') {
                        if (gameState.currentPlayer !== gameState.p1Marker) return; // Wait for bot
                        makeMove(i, gameState.p1Marker);
                        
                        if (!checkEnd()) {
                            gameState.currentPlayer = gameState.p2Marker;
                            updateStatus();
                            setTimeout(botMove, 500);
                        }
                    } else {
                        // Offline Mode
                        makeMove(i, gameState.currentPlayer);
                        if (!checkEnd()) {
                            gameState.currentPlayer = gameState.currentPlayer === gameState.p1Marker ? gameState.p2Marker : gameState.p1Marker;
                            updateStatus();
                        }
                    }
                });
            });

            // --- GAME LOGIC ---
            function initGame() {
                gameState.board.fill('');
                gameState.isActive = true;
                gameState.currentPlayer = 'X'; // X always starts rules
                
                cells.forEach(c => {
                    c.textContent = '';
                    c.className = 'cell';
                    c.disabled = false;
                });

                updateStatus();

                // If Bot is X (Player chose O), Bot starts
                if (gameState.mode === 'bot' && gameState.p2Marker === 'X') {
                    setTimeout(botMove, 600);
                }
            }

            function updateStatus() {
                if (!gameState.isActive) return;
                
                if (gameState.mode === 'offline') {
                    const currName = gameState.currentPlayer === gameState.p1Marker ? gameState.p1Name : "Player 2";
                    statusDisplay.textContent = `${currName}'s Turn (${gameState.currentPlayer})`;
                    statusDisplay.className = gameState.currentPlayer === gameState.p1Marker ? "text-xl font-semibold h-8 text-blue-300" : "text-xl font-semibold h-8 text-red-300";
                } else {
                    if (gameState.currentPlayer === gameState.p1Marker) {
                        statusDisplay.textContent = "Your Turn";
                        statusDisplay.className = "text-xl font-semibold h-8 text-blue-300";
                    } else {
                        statusDisplay.textContent = "AI is thinking...";
                        statusDisplay.className = "text-xl font-semibold h-8 text-red-300 animate-pulse";
                    }
                }
            }

            function makeMove(i, marker) {
                gameState.board[i] = marker;
                const cell = document.querySelector(`.cell[data-i="${i}"]`);
                cell.textContent = marker;
                cell.classList.add(marker === gameState.p1Marker ? 'player' : 'opponent');
                cell.disabled = true;
            }

            function checkEnd() {
                let winner = null;
                // Check win
                for (let p of winPatterns) {
                    const [a,b,c] = p;
                    if (gameState.board[a] && gameState.board[a] === gameState.board[b] && gameState.board[a] === gameState.board[c]) {
                        winner = gameState.board[a];
                        p.forEach(idx => document.querySelector(`.cell[data-i="${idx}"]`).classList.add('win'));
                        break;
                    }
                }

                if (winner) {
                    endGame(winner);
                    return true;
                }
                if (!gameState.board.includes('')) {
                    endGame('draw');
                    return true;
                }
                return false;
            }

            function endGame(result) {
                gameState.isActive = false;
                
                let text = "";
                if (result === 'draw') {
                    text = "It's a Draw!";
                    statusDisplay.className = "text-xl font-bold text-yellow-400";
                    if (gameState.mode === 'bot') generateReaction("draw");
                } else {
                    if (result === gameState.p1Marker) {
                        text = `${gameState.p1Name} Wins!`;
                        statusDisplay.className = "text-xl font-bold text-green-400";
                        gameState.scores.p1++;
                        if (gameState.mode === 'bot') {
                            if (gameState.difficulty === 'Adaptive' && gameState.adaptiveLevel < 2) gameState.adaptiveLevel++;
                            generateReaction("loss"); // Bot lost
                        }
                    } else {
                        text = gameState.mode === 'bot' ? "AI Wins!" : "Player 2 Wins!";
                        statusDisplay.className = "text-xl font-bold text-red-500";
                        gameState.scores.p2++;
                        if (gameState.mode === 'bot') {
                            if (gameState.difficulty === 'Adaptive' && gameState.adaptiveLevel > 0) gameState.adaptiveLevel--;
                            generateReaction("win"); // Bot won
                        }
                    }
                }
                statusDisplay.textContent = text;
                scoreP1.textContent = gameState.scores.p1;
                scoreP2.textContent = gameState.scores.p2;
            }

            // --- BOT BRAIN ---
            function botMove() {
                if (!gameState.isActive) return;
                
                let level = gameState.difficulty === 'Adaptive' ? gameState.adaptiveLevel : gameState.adaptiveLevel;
                let move;

                if (level === 0) move = getRandom(); // Easy
                else if (level === 1) move = getSmart(); // Medium
                else move = getMinimax(); // Hard

                makeMove(move, gameState.p2Marker);
                
                if (!checkEnd()) {
                    gameState.currentPlayer = gameState.p1Marker;
                    updateStatus();
                }
            }

            function getRandom() {
                let empty = gameState.board.map((v, i) => v === '' ? i : null).filter(v => v !== null);
                return empty[Math.floor(Math.random() * empty.length)];
            }
            function getSmart() {
                // Try win, then block, then random
                for (let m of [gameState.p2Marker, gameState.p1Marker]) {
                    for (let i = 0; i < 9; i++) {
                        if (gameState.board[i] === '') {
                            gameState.board[i] = m;
                            if (checkWinSim(m)) { gameState.board[i] = ''; return i; }
                            gameState.board[i] = '';
                        }
                    }
                }
                return getRandom();
            }
            function getMinimax() {
                let bestScore = -Infinity, move;
                for (let i = 0; i < 9; i++) {
                    if (gameState.board[i] === '') {
                        gameState.board[i] = gameState.p2Marker;
                        let score = minimax(gameState.board, 0, false);
                        gameState.board[i] = '';
                        if (score > bestScore) { bestScore = score; move = i; }
                    }
                }
                return move;
            }
            function minimax(bd, depth, isMax) {
                if (checkWinSim(gameState.p2Marker)) return 10 - depth;
                if (checkWinSim(gameState.p1Marker)) return depth - 10;
                if (!bd.includes('')) return 0;
                
                if (isMax) {
                    let best = -Infinity;
                    for(let i=0; i<9; i++) {
                        if(bd[i]==='') { bd[i]=gameState.p2Marker; best=Math.max(best, minimax(bd, depth+1, false)); bd[i]=''; }
                    }
                    return best;
                } else {
                    let best = Infinity;
                    for(let i=0; i<9; i++) {
                        if(bd[i]==='') { bd[i]=gameState.p1Marker; best=Math.min(best, minimax(bd, depth+1, true)); bd[i]=''; }
                    }
                    return best;
                }
            }
            function checkWinSim(m) {
                return winPatterns.some(p => p.every(i => gameState.board[i] === m));
            }

            // --- COMMENTARY SYSTEM ---
            function addSystemMsg(text) {
                const div = document.createElement('div');
                div.className = 'chat-message system';
                div.textContent = text;
                chatBox.appendChild(div);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            function addAIMsg(text) {
                const div = document.createElement('div');
                div.className = 'chat-message ai';
                div.textContent = text;
                chatBox.appendChild(div);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            async function generateReaction(outcome) {
                // outcome = 'win' (bot won), 'loss' (bot lost), 'draw'
                
                if (!gameState.apiKey) {
                    // Fallback messages if no API key
                    const fallbacks = {
                        win: ["I am inevitable.", "Calculated.", "Too easy.", "Nice try, human."],
                        loss: ["Impossible...", "You got lucky.", "My circuits... they hurt.", "Good game."],
                        draw: ["A stalemate.", "Perfectly balanced.", "Boring result.", "We are equal."]
                    };
                    const msg = fallbacks[outcome][Math.floor(Math.random() * fallbacks[outcome].length)];
                    addAIMsg(msg);
                    return;
                }

                // API Call
                const prompt = `You are a playful Tic-Tac-Toe AI. 
                Outcome: You just ${outcome} against player '${gameState.p1Name}'.
                Current Score: You ${gameState.scores.p2} - Player ${gameState.scores.p1}.
                Give a short, witty 1-sentence reaction.`;

                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${gameState.apiKey}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ role: 'user', parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    if(data.candidates) addAIMsg(data.candidates[0].content.parts[0].text);
                } catch(e) {
                    addSystemMsg("AI Connection Failed.");
                }
            }
        });
    </script>
</body>
</html>
